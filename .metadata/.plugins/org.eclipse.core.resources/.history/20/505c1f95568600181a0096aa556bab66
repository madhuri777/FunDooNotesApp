package com.bridgeit.fundoonotes.user.controller;

import java.io.IOException;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RestController;
import com.bridgeit.fundoonotes.user.model.ForgetPassWordDTO;
import com.bridgeit.fundoonotes.user.model.LoginDTO;
import com.bridgeit.fundoonotes.user.model.RegistrationDTO;
import com.bridgeit.fundoonotes.user.model.Response;
import com.bridgeit.fundoonotes.user.service.IUserService;


@RestController
public class UserController {

	private static final Logger LOGGER = LoggerFactory.getLogger(UserController.class);
	@Autowired
	private IUserService userService;

	@RequestMapping(value = "/registration", method = RequestMethod.POST)
	public ResponseEntity<?> save(@Validated @RequestBody RegistrationDTO registeruser, HttpServletRequest request,Response res) {

		
		String url = "http://" + request.getServerName() + ":" + request.getServerPort() + "" + request.getContextPath()
				+ "/activeuser/";
		
		boolean flag=userService.register(registeruser, url);

		res.setMessage("Registration Done");
		//if (flag) {
			return new ResponseEntity<Response>(res,HttpStatus.OK);
//		}
//		return new ResponseEntity<String>("Registrion Not Done",HttpStatus.CONFLICT);

	}

	
	
	@RequestMapping(value = "/login", method = RequestMethod.POST)
	public ResponseEntity<?> login(@RequestBody LoginDTO loginuser, HttpServletResponse response,Response res) {
      
		String token=userService.login(loginuser);
		if(token!=null) {
             res.setToken(token);
             res.setMessage("Login Successfully ");
			return new ResponseEntity<Response>(res, HttpStatus.OK);
		
		}else {
			res.setMessage("User Not Found Or User Not Activated");
			return new ResponseEntity<Response>(res,HttpStatus.CONFLICT);
		}
		}

	
	
	@RequestMapping(value = "/activeuser/{token:.+}", method = RequestMethod.GET)
	public ResponseEntity<String> activeUser(@PathVariable("token") String token) {
		// if return false put statement
		boolean status = userService.verify(token);

		if (status) {
			return new ResponseEntity<String>("User Activated", HttpStatus.CREATED);
		}
		return new ResponseEntity<String>("User Not Activated Yet", HttpStatus.NOT_ACCEPTABLE);
	}

	
	
	@RequestMapping(value = "/forgetpassword", method = RequestMethod.POST)
	public ResponseEntity<?> forgetPassWord(@RequestBody ForgetPassWordDTO forgetpasswd,
			HttpServletRequest request,Response res) {

		String url = "http://" + request.getServerName() + ":" + request.getServerPort() + "" + request.getContextPath()
				+ "/changepassword/";

		LOGGER.info("url " + url);

		String emailId = forgetpasswd.getEmail();

		if (userService.forgetPassWord(emailId, url)) {
            res.setMessage("Link Sent For Reset the passWord");
			return new ResponseEntity<Response>(res, HttpStatus.OK);
		}
		res.setMessage("User is Not verifed");
		return new ResponseEntity<Response>(res, HttpStatus.CONFLICT);
	}

	
	@RequestMapping(value="/changepassword/{token:.+}",method=RequestMethod.GET)
	public ResponseEntity<?> changePassWord(@PathVariable("token") String token,HttpServletResponse res) throws Exception{
		System.out.println("changePassWord");
		boolean flag=userService.changePassWord(token);
		if(flag) {
			res.sendRedirect("http://localhost:8081/resetPassword");
		return new ResponseEntity<String>("ok",HttpStatus.OK); 
	}
	    return new ResponseEntity<String>("Bad Request",HttpStatus.BAD_REQUEST);
	}
	
	@RequestMapping(value = "/resetpassword/{tocken:.+}", method = RequestMethod.PUT)
	public ResponseEntity<String> resetPassWord(@PathVariable("tocken") String tocken, @RequestBody String password) {

		boolean flag = userService.resetPassWord(tocken, password);

		if (flag) {

			return new ResponseEntity<String>("PssWord Set Successfuly", HttpStatus.ACCEPTED);
		}
		return new ResponseEntity<String>("Can't ResetPassWord", HttpStatus.CONFLICT);
	}

}